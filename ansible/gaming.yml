---
# Setup:
# - Debian 13 (trixie) with KDE on Wayland
# - Updated kernel through backports
# - Latest official "open" Nvidia driver
# - Game tuning (Gamemode, Mangohud, NTSYNC)
# - Game launchers (Steam, Faugus, Prism)
# - Other misc applications (Discord, Signal, Spotify, OBS, ..)
#
# References:
# - https://wiki.debian.org/Backports
# - https://wiki.debian.org/NvidiaGraphicsDrivers
# - https://wiki.debian.org/Steam
# - https://github.com/nulls0x0/debian-setup/blob/master/debian-13-nvidia-gaming-setup-guide.md
# - https://github.com/muhrizali/faugus-launcher/blob/add-new-user-guide/GUIDE.md
#
# Either specify a host, or automatically use localhost
# $ ansible-playbook -i myhost, <playbook>.yml
# $ ansible-playbook <playbook>.yml
- hosts: "{{ 'all' if ansible_play_hosts | length > 0 else 'localhost' }}"
  connection: "{{ 'ssh' if ansible_play_hosts | length > 0 else 'local' }}"

  tasks:
    - name: Gaming | Fail if not running Debian
      fail:
        msg: This playbook currently only supports Debian
      when: ansible_distribution != 'Debian'

    - name: Gaming | Add backports repo
      deb822_repository:
        name: "{{ ansible_distribution_release }}-backports"
        uris: http://ftp.no.debian.org/debian
        signed_by: /usr/share/keyrings/debian-archive-keyring.gpg
        types: deb
        suites: "{{ ansible_distribution_release }}-backports"
        components:
          - main
          - contrib
          - non-free
          - non-free-firmware
      become: yes

    # Backported 'nvidia-driver' is unfortunately also quite stale
    # If not using Ansible, see `extrepo enable nvidia-cuda`
    # https://docs.nvidia.com/datacenter/tesla/driver-installation-guide/debian.html
    - name: Gaming | Add Nvidia CUDA repo
      deb822_repository:
        name: nvidia
        uris: https://developer.download.nvidia.com/compute/cuda/repos/debian{{ ansible_distribution_major_version }}/{{ ansible_architecture }}/
        signed_by: https://developer.download.nvidia.com/compute/cuda/repos/debian13/x86_64/8793F200.pub
        types: deb
        suites: "/"
      become: yes

    # https://www.spotify.com/us/download/linux/
    - name: Gaming | Add Spotify repo
      deb822_repository:
        name: spotify
        uris: https://repository.spotify.com
        signed_by: https://download.spotify.com/debian/pubkey_5384CE82BA52C83A.asc
        types: deb
        suites: stable
        components: non-free
        architectures: amd64
      become: yes

    # https://signal.org/download/linux/
    - name: Gaming | Add Signal repo
      deb822_repository:
        name: signal
        uris: https://updates.signal.org/desktop/apt
        signed_by: https://updates.signal.org/desktop/apt/keys.asc
        types: deb
        suites: xenial
        components: main
      become: yes

    - name: Gaming | Check if multi-arch is configured
      command: dpkg --print-foreign-architectures
      changed_when: no
      register: _dpkg_foreign_arch

    - name: Gaming | Enable multi-arch (i386)
      command: dpkg --add-architecture i386
      become: yes
      when: '"i386" not in _dpkg_foreign_arch.stdout'

    - name: Gaming | Install backports packages
      apt:
        cache_valid_time: 3600
        default_release: "{{ ansible_distribution_release }}-backports"
        name:
          - linux-headers-amd64
          - linux-image-amd64
          - firmware-linux
      become: yes
      register: _backported_packages

    - name: Gaming | Notify to reboot after backported kernel installed
      pause:
        prompt: "Backported kernel installed â€“ you should probably reboot before continuing"
      when: _backported_packages.changed

    - name: Gaming | Install packages
      apt:
        cache_valid_time: 3600
        name:
          - flatpak
          - flatseal
          - gamemode
          - mangohud
          - nvidia-open # NOTE: requires Geforce Turing or newer (>= 16xx)
          - obs-studio
          - plasma-discover-backend-flatpak
          - signal-desktop
          - spotify-client
          - steam-installer
      become: yes

    # https://wiki.debian.org/Wine/NtsyncHowto
    # If not using backported kernel; verify availability using `modinfo ntsync`
    - name: Gaming | Enable NTSYNC kernel module
      modprobe:
        name: ntsync
        persistent: present
      become: yes

    - name: Gaming | Add Flathub
      flatpak_remote:
        method: user
        name: flathub
        flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo

    # NOTE: Might not be available for use before reboot
    - name: Gaming | Install flatpaks
      flatpak:
        method: user
        name:
          - com.discordapp.Discord
          - org.prismlauncher.PrismLauncher

    - name: Gaming | Get Faugus launcher release info
      uri:
        url: https://api.github.com/repos/Faugus/faugus-launcher/releases/latest
      check_mode: no
      register: _faugus_release

    - name: Gaming | Install Faugus launcher
      apt:
        deb: "{{ (_faugus_release.json.assets | selectattr('content_type', 'eq', 'application/vnd.debian.binary-package') | first).browser_download_url }}"
      become: yes
